<?php

    $empty = $post = array();
    foreach ($_POST as $varname => $varvalue) {
        if (empty($varvalue)) {
            $empty[$varname] = $varvalue;
        } else {
            $post[$varname] = $varvalue;
        }
    }
    if ($_POST) {
        echo '<pre>';
        echo htmlspecialchars(print_r($empty, true));
        echo htmlspecialchars(print_r($post, true));
        echo '</pre>';
    }

    include_once '../config/dbms-connection.php';
    mysqli_report(MYSQLI_REPORT_ERROR | MYSQLI_REPORT_STRICT);
    
    if ($_SERVER['REQUEST_METHOD'] == "GET") {
        //header('Content-Type: text/plain');
        echo "This HTTP resource is designed to handle POST XML input <br>";
        echo "from localhost:8080 and not be retrieved with GET";
    }
    elseif($_SERVER['REQUEST_METHOD'] == "POST") {

        echo "POST Request done!<p>";

        // Handle POST by first getting the XML POST blob,
        // and then doing something to it, and then sending results to the Client
        if (isset($_POST['USERNAME']) && isset($_POST['PASSWORD'])) {
            
            $username = $_POST['USERNAME'];
            $password = $_POST['PASSWORD'];
            
            // QUERY
            echo "SELECT * FROM Utente WHERE username='$username' AND password='$password' <p>";
            //$query = "SELECT * FROM table WHERE username='" . $username . "' AND password= '" . $password . "';";
            $query = "SELECT * FROM Utente WHERE username='$username' AND password='$password'";

            // RESULT
            $result = $mysqli->query($query) or die('[FAILED QUERY]: '. $mysqli->error_get_last());

            // PRINT RECORDS
            $result_table = "<table class=\"table\"> 
            <thead>
                <tr>
                    <th scope=\"col\">id</th>
                    <th scope=\"col\">Matricola</th>
                    <th scope=\"col\">Nome</th>
                    <th scope=\"col\">Cognome</th>
                    <th scope=\"col\">Email</th>
                    <th scope=\"col\">Username</th>
                    <th scope=\"col\">Password</th>
                    <th scope=\"col\">Ruolo</th>
                </tr>
            </thead>
            <tbody>";

            //$records = $result->fetch_assoc() OR die("No user found!");
            
            /* fetch associative array */
            while ($row = $result->fetch_assoc()) {
                $result_table = $result_table . 
                "<tr>
                    <th scope=\"row\">".$row['id']."</th>
                    <td>".$row['Matricola']."</td>
                    <td>".$row['Nome']."</td>
                    <td>".$row['Cognome']."</td>
                    <td>".$row['Email']."</td>
                    <td>".$row['Username']."</td>
                    <td>".$row['Password']."</td>
                    <td>".$row['Ruolo']."</td>
                <tr>";
            }

            $result_table = $result_table . "</tbody></table>";
            echo "<h3> Tabella Risultati </h3>";
            echo $result_table;
            
            // Free results
            mysqli_free_result($result);
        }
    }else{
        die("No Other Methods Allowed");
    }

    